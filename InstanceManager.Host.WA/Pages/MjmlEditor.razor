@page "/mjml-editor"
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@using System.Text.Json.Serialization
@using System.Net.Http.Json
@using BlazorMonaco
@using BlazorMonaco.Editor
@implements IDisposable

<h3>MJML Editor</h3>

<div class="container-fluid">
    <div class="row">
        <div class="col-6">
            <label>MJML</label>
            <StandaloneCodeEditor @ref="mjmlEditor" ConstructionOptions="MjmlEditorConstructionOptions" OnDidChangeContent="OnMjmlContentChanged" />
            <label>Variables</label>
            <StandaloneCodeEditor @ref="variablesEditor" ConstructionOptions="VariablesEditorConstructionOptions" OnDidChangeContent="OnVariablesContentChanged" />
        </div>
        <div class="col-6">
            <div class="btn-group" role="group" aria-label="Preview size">
              <button type="button" class="btn btn-secondary" @onclick='() => SetPreviewSize("375px")'>Small</button>
              <button type="button" class="btn btn-secondary" @onclick='() => SetPreviewSize("768px")'>Medium</button>
              <button type="button" class="btn btn-secondary" @onclick='() => SetPreviewSize("100%")'>Large</button>
            </div>
            <iframe srcdoc="@htmlOutput" style="width: @previewWidth; height: calc(100vh - 150px); border: 1px solid #ccc;" />
        </div>
    </div>
</div>

@code {
    private StandaloneCodeEditor mjmlEditor = null!;
    private StandaloneCodeEditor variablesEditor = null!;

    private string previewWidth = "100%";

    private void SetPreviewSize(string width)
    {
        previewWidth = width;
    }

    private StandaloneEditorConstructionOptions MjmlEditorConstructionOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            Language = "html",
            Value = @"<mjml>
                  <mj-body>
                    <mj-section>
                      <mj-column>
                        <mj-text>
                          Hello {{ name }}!
                        </mj-text>
                      </mj-column>
                    </mj-section>
                  </mj-body>
                </mjml>",
            AutomaticLayout = true
        };
    }

    private StandaloneEditorConstructionOptions VariablesEditorConstructionOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            Language = "json",
            Value = @"{
                      ""name"": ""World""
                    }",
            AutomaticLayout = true
        };
    }

    private string htmlOutput = "";
    private Timer? _debounceTimer;
    private const int DebounceTimeMs = 500;

    protected override void OnInitialized()
    {
        _debounceTimer = new Timer(async _ => await OnTimerCallback(), null, Timeout.Infinite, Timeout.Infinite);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await OnTimerCallback();
        }
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }

    private async Task OnTimerCallback()
    {
        var mjml = await mjmlEditor.GetValue();
        var variables = await variablesEditor.GetValue();
        await ConvertMjmlToHtml(mjml, variables);
    }

    private Task OnMjmlContentChanged()
    {
        _debounceTimer?.Change(DebounceTimeMs, Timeout.Infinite);
        return Task.CompletedTask;
    }

    private Task OnVariablesContentChanged()
    {
        _debounceTimer?.Change(DebounceTimeMs, Timeout.Infinite);
        return Task.CompletedTask;
    }

    private async Task ConvertMjmlToHtml(string mjml, string variables)
    {
        try
        {
            var mjmlResult = await JSRuntime.InvokeAsync<MjmlResult>("mjml", mjml);

            if (mjmlResult.Errors.Length > 0)
            {
                var errorString = string.Join(", ", mjmlResult.Errors.Select(e => e.ToString()));
                htmlOutput = $"<p>MJML Errors: {errorString}</p>";
            }
            else
            {
                var response = await Http.PostAsJsonAsync("http://localhost:7071/api/mjml/render", new { html = mjmlResult.Html, variables });

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<ScribanResult>();
                    htmlOutput = result.Html;
                }
                else
                {
                    htmlOutput = $"<p>Error: {response.ReasonPhrase}</p>";
                }
            }
        }
        catch (Exception ex)
        {
            htmlOutput = $"<p>Error converting MJML: {ex.Message}</p>";
        }

        await InvokeAsync(StateHasChanged);
    }

    public class MjmlResult
    {
        [JsonPropertyName("html")]
        public string Html { get; set; } = "";
        [JsonPropertyName("errors")]
        public object[] Errors { get; set; } = [];
    }

    public class ScribanResult
    {
        [JsonPropertyName("html")]
        public string Html { get; set; } = "";
    }
}
