@page "/mjml-editor"
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@using System.Text.Json.Serialization
@using System.Net.Http.Json
@implements IDisposable

<h3>MJML Editor</h3>

<div class="container-fluid">
    <div class="row">
        <div class="col-6">
            <label>MJML</label>
            <textarea class="form-control" @bind="MjmlInput" @bind:event="oninput" rows="20" style="width: 100%; height: calc(100vh - 200px);"></textarea>
            <label>Variables</label>
            <textarea class="form-control" @bind="Variables" @bind:event="oninput" rows="5"></textarea>
        </div>
        <div class="col-6">
            <div class="btn-group" role="group" aria-label="Preview size">
              <button type="button" class="btn btn-secondary" @onclick='() => SetPreviewSize("375px")'>Small</button>
              <button type="button" class="btn btn-secondary" @onclick='() => SetPreviewSize("768px")'>Medium</button>
              <button type="button" class="btn btn-secondary" @onclick='() => SetPreviewSize("100%")'>Large</button>
            </div>
            <iframe srcdoc="@htmlOutput" style="width: @previewWidth; height: calc(100vh - 150px); border: 1px solid #ccc;" />
        </div>
    </div>
</div>

@code {
    private string previewWidth = "100%";

    private void SetPreviewSize(string width)
    {
        previewWidth = width;
    }

    private string _mjmlInput = @"""
                               <mjml>
                                 <mj-body>
                                   <mj-section>
                                     <mj-column>
                                       <mj-text>
                                         Hello World!
                                       </mj-text>
                                     </mj-column>
                                   </mj-section>
                                 </mj-body>
                               </mjml>
                               """;

    private string _variables = "{\n  \"name\": \"World\"\n}";
    private string htmlOutput = "";
    private Timer? _debounceTimer;
    private const int DebounceTimeMs = 500;

    private string MjmlInput
    {
        get => _mjmlInput;
        set
        {
            _mjmlInput = value;
            // Reset the timer on each input
            _debounceTimer?.Change(DebounceTimeMs, Timeout.Infinite);
        }
    }

    private string Variables
    {
        get => _variables;
        set
        {
            _variables = value;
            _debounceTimer?.Change(DebounceTimeMs, Timeout.Infinite);
        }
    }

    protected override async void OnInitialized()
    {
        _debounceTimer = new Timer(async _ => await OnTimerCallback(), null, DebounceTimeMs, Timeout.Infinite);
    }

    private async Task OnTimerCallback()
    {
        await ConvertMjmlToHtml();
    }

    private async Task ConvertMjmlToHtml()
    {
        try
        {
            var mjmlResult = await JSRuntime.InvokeAsync<MjmlResult>("mjml", _mjmlInput);

            if (mjmlResult.Errors.Length > 0)
            {
                var errorString = string.Join(", ", mjmlResult.Errors.Select(e => e.ToString()));
                htmlOutput = $"<p>MJML Errors: {errorString}</p>";
            }
            else
            {
                var response = await Http.PostAsJsonAsync("http://localhost:7071/api/mjml/render", new { html = mjmlResult.Html, variables = _variables });

                if (response.IsSuccessStatusCode)
                {
                    var result = await response.Content.ReadFromJsonAsync<ScribanResult>();
                    htmlOutput = result.Html;
                }
                else
                {
                    htmlOutput = $"<p>Error: {response.ReasonPhrase}</p>";
                }
            }
        }
        catch (Exception ex)
        {
            htmlOutput = $"<p>Error converting MJML: {ex.Message}</p>";
        }

        await InvokeAsync(StateHasChanged);
    }

    public class MjmlResult
    {
        [JsonPropertyName("html")]
        public string Html { get; set; } = "";
        [JsonPropertyName("errors")]
        public object[] Errors { get; set; } = [];
    }

    public class ScribanResult
    {
        [JsonPropertyName("html")]
        public string Html { get; set; } = "";
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}
